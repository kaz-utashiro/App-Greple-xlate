=encoding utf-8

=head1 NAME

App::Greple::xlate — модуль поддержки перевода для greple

=head1 SYNOPSIS

    greple -Mxlate::deepl --xlate pattern target-file

    greple -Mxlate::gpt4 --xlate pattern target-file

    greple -Mxlate::gpt5 --xlate pattern target-file

    greple -Mxlate --xlate-engine gpt5 --xlate pattern target-file

=head1 VERSION

Version 0.9914

=head1 DESCRIPTION

B<Greple> B<xlate> модуль находит нужные текстовые блоки и заменяет их переведенным текстом. В настоящее время модули DeepL (F<deepl.pm>), ChatGPT 4.1 (F<gpt4.pm>) и GPT-5 (F<gpt5.pm>) реализованы как серверные движки.

Если вы хотите переводить обычные текстовые блоки в документе, написанном в стиле pod языка Perl, используйте команду B<greple> с модулями C<xlate::deepl> и C<perl> следующим образом:

    greple -Mxlate::deepl -Mperl --pod --re '^([\w\pP].*\n)+' --all foo.pm

В этой команде строка шаблона C<^([\w\pP].*\n)+> означает последовательные строки, начинающиеся с буквенно-цифрового символа и знака пунктуации. Эта команда показывает подсвеченную область для перевода. Опция B<--all> используется для вывода всего текста.

=for html <p>
<img width="750" src="https://raw.githubusercontent.com/kaz-utashiro/App-Greple-xlate/main/images/select-area.png">
</p>

Затем добавьте опцию C<--xlate> для перевода выбранной области. После этого будут найдены нужные разделы и заменены выводом команды B<deepl>.

По умолчанию исходный и переведенный текст выводятся в формате «маркер конфликта», совместимом с L<git(1)>. Используя формат C<ifdef>, вы можете легко получить нужную часть командой L<unifdef(1)>. Формат вывода можно указать опцией B<--xlate-format>.

=for html <p>
<img width="750" src="https://raw.githubusercontent.com/kaz-utashiro/App-Greple-xlate/main/images/format-conflict.png">
</p>

Если вы хотите перевести весь текст, используйте опцию B<--match-all>. Это сокращение для указания шаблона C<(?s).+>, который соответствует всему тексту.

Данные в формате маркеров конфликтов можно просматривать в поколоночном виде командой L<sdif|App::sdif> с опцией C<-V>. Поскольку не имеет смысла сравнивать построчно, рекомендуется опция C<--no-cdif>. Если вам не нужно раскрашивание текста, укажите C<--no-textcolor> (или C<--no-tc>).

    sdif -V --no-filename --no-tc --no-cdif data_shishin.deepl-EN-US.cm

=for html <p>
<img width="750" src="https://raw.githubusercontent.com/kaz-utashiro/App-Greple-xlate/main/images/sdif-cm-view.png">
</p>

=head1 NORMALIZATION

Обработка выполняется в заданных единицах, но в случае последовательности из нескольких строк непустого текста они преобразуются вместе в одну строку. Эта операция выполняется следующим образом:

=over 2

=item *

Удалите пробелы в начале и в конце каждой строки.

=item *

Если строка заканчивается полноширинным знаком препинания, объедините с следующей строкой.

=item *

Если строка заканчивается полноширинным символом и следующая строка начинается полноширинным символом, объедините строки.

=item *

Если либо конец, либо начало строки не является полноширинным символом, объедините их, вставив пробел.

=back

Данные кэша управляются на основе нормализованного текста, поэтому даже если вносятся изменения, не влияющие на результаты нормализации, кэшированные данные перевода останутся эффективными.

Этот процесс нормализации выполняется только для первого (0-го) и четных шаблонов. Таким образом, если указаны два шаблона, как показано ниже, текст, соответствующий первому шаблону, будет обработан после нормализации, а к тексту, соответствующему второму шаблону, процесс нормализации применяться не будет.

    greple -Mxlate -E normalized -E not-normalized

Поэтому используйте первый шаблон для текста, который должен обрабатываться путем объединения нескольких строк в одну, а второй — для предварительно форматированного текста. Если в первом шаблоне нет текста для совпадения, используйте шаблон, который ни с чем не совпадает, например C<(?!)>.

=head1 MASKING

Иногда встречаются части текста, которые не нужно переводить. Например, теги в файлах Markdown. DeepL рекомендует в таких случаях преобразовать исключаемую часть текста в XML‑теги, выполнить перевод, а затем восстановить её после завершения перевода. Для поддержки этого можно указать части, которые следует маскировать от перевода.

    --xlate-setopt maskfile=MASKPATTERN

Каждая строка файла `MASKPATTERN` будет интерпретироваться как регулярное выражение, соответствующие ему строки будут переведены и восстановлены после обработки. Строки, начинающиеся с C<#>, игнорируются.

Сложный шаблон можно записывать на нескольких строках с экранированным обратной косой чертой переводом строки.

То, как текст преобразуется при маскировании, можно увидеть с опцией B<--xlate-mask>.

Этот интерфейс является экспериментальным и может измениться в будущем.

=head1 OPTIONS

=over 7

=item B<--xlate>

=item B<--xlate-color>

=item B<--xlate-fold>

=item B<--xlate-fold-width>=I<n> (Default: 70)

Запустить процесс перевода для каждой совпавшей области.

Без этой опции B<greple> работает как обычная команда поиска. Так вы можете проверить, какая часть файла будет подвергнута переводу, прежде чем запускать фактическую работу.

Результат команды выводится в стандартный вывод, поэтому при необходимости перенаправьте в файл или рассмотрите использование модуля L<App::Greple::update>.

Опция B<--xlate> вызывает опцию B<--xlate-color> с опцией B<--color=never>.

С опцией B<--xlate-fold> преобразованный текст переносится по указанной ширине. Ширина по умолчанию — 70 и может быть задана опцией B<--xlate-fold-width>. Четыре столбца зарезервированы для операции run‑in, поэтому каждая строка может содержать максимум 74 символа.

=item B<--xlate-engine>=I<engine>

Указывает, какой использовать движок перевода. Если вы укажете модуль движка напрямую, например C<-Mxlate::deepl>, эту опцию можно не использовать.

В настоящее время доступны следующие движки

=over 2

=item * B<deepl>: DeepL API

=item * B<gpt3>: gpt-3.5-turbo

=item * B<gpt4>: gpt-4.1

=item * B<gpt4o>: gpt-4o-mini

Интерфейс B<gpt-4o> нестабилен и на данный момент не гарантирует корректную работу.

=item * B<gpt5>: gpt-5

=back

=item B<--xlate-labor>

=item B<--xlabor>

Вместо вызова движка перевода предполагается, что вы выполните работу вручную. После подготовки текста к переводу он копируется в буфер обмена. Ожидается, что вы вставите его в форму, скопируете результат в буфер обмена и нажмёте Enter.

=item B<--xlate-to> (Default: C<EN-US>)

Укажите целевой язык. Доступные языки можно получить командой C<deepl languages> при использовании движка B<DeepL>.

=item B<--xlate-format>=I<format> (Default: C<conflict>)

Укажите формат вывода для исходного и переведённого текста.

Следующие форматы, кроме C<xtxt>, предполагают, что часть для перевода представляет собой набор строк. Фактически возможно переводить только часть строки, но указание формата, отличного от C<xtxt>, не даст осмысленных результатов.

=over 4

=item B<conflict>, B<cm>

Исходный и преобразованный текст выводятся в формате конфликтных маркеров L<git(1)>.

    <<<<<<< ORIGINAL
    original text
    =======
    translated Japanese text
    >>>>>>> JA

Вы можете восстановить исходный файл следующей командой L<sed(1)>.

    sed -e '/^<<<<<<< /d' -e '/^=======$/,/^>>>>>>> /d'

=item B<colon>, I<:::::::>

Исходный и переведённый текст выводятся в стиле пользовательского контейнера markdown.

    ::::::: ORIGINAL
    original text
    :::::::
    ::::::: JA
    translated Japanese text
    :::::::

Приведённый выше текст будет преобразован в HTML следующим образом.

    <div class="ORIGINAL">
    original text
    </div>
    <div class="JA">
    translated Japanese text
    </div>

Количество двоеточий по умолчанию — 7. Если указать последовательность двоеточий, такую как C<:::::>, она будет использована вместо 7 двоеточий.

=item B<ifdef>

Исходный и преобразованный текст выводятся в формате L<cpp(1)> C<#ifdef>.

    #ifdef ORIGINAL
    original text
    #endif
    #ifdef JA
    translated Japanese text
    #endif

Вы можете получить только японский текст с помощью команды B<unifdef>:

    unifdef -UORIGINAL -DJA foo.ja.pm

=item B<space>

=item B<space+>

Исходный и преобразованный текст выводятся, разделённые одной пустой строкой. Для C<space+> после преобразованного текста также выводится перевод строки.

=item B<xtxt>

Если формат — C<xtxt> (переведённый текст) или неизвестный, выводится только переведённый текст.

=back

=item B<--xlate-maxlen>=I<chars> (Default: 0)

Укажите максимальную длину текста, отправляемого в API за один раз. Значение по умолчанию установлено для бесплатного сервиса DeepL: 128K для API (B<--xlate>) и 5000 для интерфейса буфера обмена (B<--xlate-labor>). Вы можете изменить эти значения при использовании Pro-сервиса.

=item B<--xlate-maxline>=I<n> (Default: 0)

Укажите максимальное количество строк текста, отправляемых в API за один раз.

Установите значение 1, если хотите переводить по одной строке за раз. Этот параметр имеет приоритет над опцией C<--xlate-maxlen>.

=item B<--xlate-prompt>=I<text>

Укажите пользовательский промпт, отправляемый в движок перевода. Эта опция доступна только при использовании движков ChatGPT (gpt3, gpt4, gpt4o). Вы можете настроить поведение перевода, предоставив конкретные инструкции модели ИИ. Если промпт содержит C<%s>, он будет заменён названием целевого языка.

=item B<--xlate-context>=I<text>

Укажите дополнительную контекстную информацию, передаваемую движку перевода. Эту опцию можно указывать несколько раз для передачи нескольких контекстных строк. Контекст помогает движку перевода понимать фон и выдавать более точные переводы.

=item B<--xlate-glossary>=I<glossary>

Укажите идентификатор глоссария для использования при переводе. Эта опция доступна только при использовании движка DeepL. Идентификатор глоссария должен быть получен в вашем аккаунте DeepL и обеспечивает единообразный перевод специальных терминов.

=item B<-->[B<no->]B<xlate-progress> (Default: True)

Смотрите результат перевода в реальном времени в выводе STDERR.

=item B<--xlate-stripe>

Используйте модуль L<App::Greple::stripe> для подсветки совпавших частей в виде зебры. Это полезно, когда совпавшие части идут вплотную друг к другу.

Палитра цветов переключается в зависимости от фонового цвета терминала. Если хотите указать явно, используйте B<--xlate-stripe-light> или B<--xlate-stripe-dark>.

=item B<--xlate-mask>

Выполнить маскирование и вывести преобразованный текст как есть, без восстановления.

=item B<--match-all>

Установить весь текст файла как целевую область.

=item B<--lineify-cm>

=item B<--lineify-colon>

В форматах C<cm> и C<colon> вывод разбивается и форматируется построчно. Поэтому, если требуется перевести только часть строки, ожидаемый результат получить нельзя. Эти фильтры исправляют вывод, искажённый переводом части строки, приводя его к нормальному построчному виду.

В текущей реализации, если переводятся несколько частей одной строки, они выводятся как независимые строки.

=back

=head1 CACHE OPTIONS

Модуль B<xlate> может кэшировать переводы для каждого файла и читать их перед выполнением, чтобы устранить накладные расходы на обращение к серверу. С стратегией кэширования по умолчанию C<auto> кэш поддерживается только если для целевого файла существует кэш-файл.

Используйте B<--xlate-cache=clear> для инициализации управления кэшем или очистки всех существующих кэш-данных. После выполнения с этой опцией новый кэш-файл будет создан, если его ещё нет, и впоследствии будет автоматически поддерживаться.

=over 7

=item --xlate-cache=I<strategy>

=over 4

=item C<auto> (Default)

Поддерживать кэш-файл, если он существует.

=item C<create>

Создать пустой кэш-файл и выйти.

=item C<always>, C<yes>, C<1>

В любом случае поддерживать кеш, если целевой объект — обычный файл.

=item C<clear>

Сначала очистите данные кеша.

=item C<never>, C<no>, C<0>

Никогда не используйте файл кеша, даже если он существует.

=item C<accumulate>

По умолчанию неиспользуемые данные удаляются из файла кеша. Если вы не хотите их удалять и хотите сохранить в файле, используйте C<accumulate>.

=back

=item B<--xlate-update>

Эта опция принудительно обновляет файл кеша, даже если в этом нет необходимости.

=back

=head1 COMMAND LINE INTERFACE

Вы можете легко использовать этот модуль из командной строки с помощью команды C<xlate>, включенной в дистрибутив. См. страницу руководства C<xlate> для использования.

Команда C<xlate> работает совместно со средой Docker, поэтому, даже если у вас ничего не установлено, вы можете использовать её при наличии Docker. Используйте опцию C<-D> или C<-C>.

Кроме того, поскольку предоставлены makefile-файлы для различных стилей документов, перевод на другие языки возможен без специальной настройки. Используйте опцию C<-M>.

Вы также можете комбинировать опции Docker и C<make>, чтобы запускать C<make> в среде Docker.

Запуск вида C<xlate -C> откроет оболочку с примонтированным текущим рабочим репозиторием git.

Подробности см. в японской статье в разделе L</SEE ALSO>.

=head1 EMACS

Загрузите файл F<xlate.el>, включённый в репозиторий, чтобы использовать команду C<xlate> из редактора Emacs. Функция C<xlate-region> переводит заданный регион. Язык по умолчанию — C<EN-US>, а язык можно указать, вызывая её с префиксным аргументом.

=for html <p>
<img width="750" src="https://raw.githubusercontent.com/kaz-utashiro/App-Greple-xlate/main/images/emacs.png">
</p>

=head1 ENVIRONMENT

=over 7

=item DEEPL_AUTH_KEY

Установите свой ключ аутентификации для сервиса DeepL.

=item OPENAI_API_KEY

Ключ аутентификации OpenAI.

=back

=head1 INSTALL

=head2 CPANMINUS

    $ cpanm App::Greple::xlate

=head2 TOOLS

Необходимо установить инструменты командной строки для DeepL и ChatGPT.

L<https://github.com/DeepLcom/deepl-python>

L<https://github.com/tecolicom/App-gpty>

=head1 SEE ALSO

L<App::Greple::xlate>

L<App::Greple::xlate::deepl>

L<App::Greple::xlate::gpt4>

L<App::Greple::xlate::gpt5>

=over 2

=item * L<https://hub.docker.com/r/tecolicom/xlate>

Образ контейнера Docker.

=item * L<https://github.com/DeepLcom/deepl-python>

Библиотека DeepL на Python и утилита CLI.

=item * L<https://github.com/openai/openai-python>

Библиотека OpenAI для Python

=item * L<https://github.com/tecolicom/App-gpty>

Интерфейс командной строки OpenAI

=item * L<App::Greple>

См. руководство B<greple> для подробностей о целевом шаблоне текста. Используйте опции B<--inside>, B<--outside>, B<--include>, B<--exclude> для ограничения области сопоставления.

=item * L<App::Greple::update>

Вы можете использовать модуль C<-Mupdate> для изменения файлов по результатам команды B<greple>.

=item * L<App::sdif>

Используйте B<sdif> для отображения формата маркера конфликта рядом с опцией B<-V>.

=item * L<App::Greple::stripe>

Модуль Greple B<stripe> используется опцией B<--xlate-stripe>.

=back

=head2 ARTICLES

=over 2

=item * L<https://qiita.com/kaz-utashiro/items/1c1a51a4591922e18250>

Модуль Greple для перевода и замены только необходимых частей с помощью API DeepL (на японском)

=item * L<https://qiita.com/kaz-utashiro/items/a5e19736416ca183ecf6>

Генерация документов на 15 языках с модулем API DeepL (на японском)

=item * L<https://qiita.com/kaz-utashiro/items/1b9e155d6ae0620ab4dd>

Среда Docker для автоматического перевода с API DeepL (на японском)

=back

=head1 AUTHOR

Kazumasa Utashiro

=head1 LICENSE

Copyright © 2023-2025 Kazumasa Utashiro.

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

=cut
