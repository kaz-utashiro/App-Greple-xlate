# Greple -Mxlate モジュール サンプルファイル

このディレクトリには、Greple の -Mxlate モジュールを使ってファイルを自
動翻訳する例が含まれています。

もし、この文章を日本語以外の言語で読んでいるとしたら、それはこの仕組み
を使って自動翻訳して生成されたものです。多少おかしな点があっても我慢し
てください。もし日本語で読んでいてもおかしな点があったら、それは作者の
頭がおかしいので、やはり我慢するか、優しく指摘してください。

翻訳したい文書ファイルを置いて、make コマンドを実行するだけで必要なファ
イルを生成します。現時点で対象としているのは、以下の種類のファイルです。

- `*.docx`
- `*.pptx`
- `*.txt`
- `*.md`
- `*.pm`

## 生成ファイル

### 単一 ENGINE の場合

特に指定がない場合には、翻訳対象言語毎に `xtxt`, `cm`, `ifdef` の3種類
のファイルが作られます。

たとえば、`Document.txt` というファイルを日本語に翻訳する場合、

    Document.txt.JA.xtxt
    Document.txt.JA.cm
    Document.txt.JA.ifdef

という3つのファイルが生成されます。`xtxt` ファイルには、翻訳文章のみ、
`cm` と `ifdef` には原文と訳文の両方が含まれます。

### 複数 ENGINE の場合

ENGINE に `deepl` と `gpt4` の2つが指定されていた場合は、次のようにエ
ンジン名を含むファイルを生成します。

    Document.txt.deepl-JA.xtxt
    Document.txt.deepl-JA.cm
    Document.txt.deepl-JA.ifdef
    Document.txt.gpt4-JA.xtxt
    Document.txt.gpt4-JA.cm
    Document.txt.gpt4-JA.ifdef

## 行の折り返し

形式指定に、たとえば `cm-fold` の様に、最後に `-fold` を付けると、出力
を80カラムで折り返します。

## 制御ファイル

対象ファイルに特定の拡張子が付いたファイルがあると、その内容によって翻
訳処理を制御することができます。たとえば、`Document.txt` というファイ
ルと共に `Document.txt.LANG` というファイルがあれば、その中に書かれて
いる言語に翻訳します。

### .ENGINE

翻訳エンジンの指定。デフォルトの `deepl` と `gpt4` が指定できます。
デフォルトは `deepl` です。

### .LANG

翻訳対象言語の指定。

### .FORMAT

翻訳形式を指定。通常は `xtxt`、`cm`、`ifdef` の中から指定します。

他の形式、たとえば `md` することもできますが、その場合は `xtxt` と同様
の内容になります。ただ `.md` で終わるファイルを生成すると、次回はその
ファイルも翻訳対象になってしまうので注意して使う必要があります。

## 翻訳処理

デフォルトの動作では、翻訳対象となるテキストをクリップボードにコピーし
た状態で、翻訳処理を促すプロンプトが表示されます。DeepL のアプリケーショ
ンやウェブインタフェースを使ってそれを翻訳し、結果を再びクリップボード
にコピーしてから、エンターキーを押してください。

### 文字数制限

フリーアカウントで実行している場合には、一度に5000文字までしか処理でき
ないので、すべてのテキストの処理が終わるまでこの作業を繰り返します。

有料アカウントを使っていて、処理する文字数に制限がない場合には `MAXLEN`
という変数に上限を設定して実行してください。

    make MAXLEN=100000

### DeepL API を利用する

API を使って翻訳する場合には `deepl` コマンドがインストールされている
必要があります。`USEAPI` という変数をセットして make を実行してくださ
い。ただし、Docker コンテナ上で実行する場合は `deepl` コマンドは不要で
す。

    make USEAPI=yes

API を利用する場合は、最大文字数は 128K に設定されます。認証キーは環境
変数 `DEEPL_AUTH_KEY` に設定します。必要に応じて`DEEPL_SERVER_URL` 等
の環境変数を設定してください。

### Docker コンテナを利用する

`DOCKER` という変数を有効にして make を実行してください。

    make DOCKER=yes

### `XLATE_OPT` 変数

`xlate` コマンドに与えるオプションを指定することもできます。

    make XLATE_OPT=-Dam100000

のようにすれば、API を利用して、文字数制限を10万文字に設定して、Docker
上で実行することができます。

## xlate スクリプト

当初、これらのファイルは Makefile によって処理するように作りましたが、
現在はそこで使われていた設定をより汎用的なものとし、`xlate` というスク
リプトで自動的に処理するようにしてあります。ですから、現在の Makefile
は、単に `xlate` コマンドを呼び出すだけのものになっています。`xlate`
が使用する Makefile は `../share/XLATE.mk` にあります。

ヘルプを見るためには `xlate -h` を実行してください。

### `xlate -M`

make を実行します。

### `xlate -D`

Docker 環境で xlate コマンドを実行します。

### `xlate -C`

Docker 環境でコマンドを実行します。

`-C` に続けてコマンドを指定するとそのコマンドを実行します。
何も指定しない場合には、シェルが立ち上がります。

デフォルトでは、現行ディレクトリが `/work` ディレクトリにマウントされ
ます。git 環境を使いたい場合は、次の `-G` オプションを使ってください。

読み込みのみでマウントしたければ `-R` オプションを指定します。

#### `xlate -G`

Docker 環境を構築する際に、現在の git リポジトリのトップディレクトリを
マウントします。

#### `xlate -GM`

現在の git リポジトリをマウントして、Docker 環境で make を実行します。

どのようなコマンドを実行するか確認したい場合には `xlate -GMn` のように
`-n` オプションを指定することができます。

#### `xlate -GC`

Git リポジトリをマウントして Docker 環境でシェルを立ち上げます。

Git やその他のツールが一式インストールしてあるので、そのまま作業するこ
とができます。作業ディレクトリをマウントするので、そこで行った修正は元
のファイルに反映されることに注意してください。
